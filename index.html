<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Conference Buddy â€“ Reports (Production Workflow)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121820; --muted:#7b8a9a; --text:#e6eef6; --accent:#7dd3fc; --accent2:#a78bfa; --good:#34d399; --warn:#f59e0b; --bad:#ef4444;
      --br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:linear-gradient(180deg,#0b0f14,#0a0e13 35%,#0b0f14); color:var(--text)}
    .wrap{max-width:1100px; margin:40px auto; padding:0 20px}

    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px}
    h1{font-size:clamp(20px,3vw,28px); margin:0}
    .card{background:rgba(18,24,32,.8); border:1px solid rgba(125,211,252,.12); border-radius:var(--br); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25)}

    .grid{display:grid; gap:14px}
    .grid.cols-3{grid-template-columns:1fr}
    @media(min-width:980px){ .grid.cols-3{grid-template-columns:1.1fr 1fr 1fr} }

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, button{width:100%}
    input, select{background:#0f141b; color:var(--text); border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:10px; outline:none}
    input::placeholder{color:#5e6b79}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }

    .tiny{font-size:12px; color:var(--muted)}
    .hint{color:#9fb0c3; font-size:12px}
    .inline{display:flex; gap:10px; align-items:center}
    .btnbar{display:flex; flex-wrap:wrap; gap:10px}
    button{background:linear-gradient(180deg, rgba(125,211,252,.14), rgba(167,139,250,.14)); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    button.secondary{background:transparent}
    button.ghost{background:transparent; border-style:dashed}
    button:disabled{opacity:.55; cursor:not-allowed}

    .status{margin-top:12px; font-size:13px}
    .status span{padding:4px 8px; border-radius:999px}
    .ok{background:rgba(52,211,153,.12); color:var(--good)}
    .warn{background:rgba(245,158,11,.12); color:var(--warn)}
    .err{background:rgba(239,68,68,.12); color:var(--bad)}

    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px; background:#0d1218; border:1px solid rgba(255,255,255,.08); padding:2px 6px; border-radius:6px}
    .divider{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); margin:14px 0}

    footer#outputBar{position:sticky; bottom:0; margin-top:16px}
    #logPanel{max-height:260px; overflow:auto}
    .row.actions{grid-template-columns: auto auto 1fr auto}
    @media(max-width:640px){ .row.actions{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ§­ Conference Buddy â€“ Reports</h1>
      <div class="inline hint">
        <span class="kbd">/api/conferences</span>
        <span class="kbd">/api/vendors</span>
        <span class="kbd">/api/reports/*</span>
      </div>
    </header>

    <!-- Configuration -->
    <section class="card" aria-labelledby="cfg">
      <h2 id="cfg" style="margin-top:0">Configuration</h2>
      <div class="row">
        <div>
          <label for="baseUrl">API Base URL</label>
          <input id="baseUrl" type="url" placeholder="https://example.com/api" />
          <div class="tiny">Default: <span class="kbd">https://conference-buddy-geoutils.replit.app/api</span></div>
        </div>
        <div>
          <label for="apiKey">API Key</label>
          <input id="apiKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="tiny">Saved only in this browser (localStorage).</div>
        </div>
      </div>

      <div class="row actions" style="align-items:center; gap:10px; margin-top:6px">
        <button id="btnSaveRefresh">Save & Refresh</button>
        <button id="btnRefresh" class="secondary">Refresh</button>
        <div class="tiny" id="lastRefreshed">Last refreshed: â€”</div>
        <button id="btnClearCreds" class="ghost" title="Clear saved base URL & API key">Clear saved creds</button>
      </div>

      <div class="divider"></div>

      <h3 style="margin:8px 0 6px">Scope</h3>
      <div class="row">
        <div>
          <label for="conferenceSelect">Conference</label>
          <select id="conferenceSelect"></select>
          <div class="tiny">From <span class="kbd">/api/conferences</span>.</div>
        </div>
        <div>
          <label for="vendorSelect">Vendor (multi-select optional)</label>
          <select id="vendorSelect" multiple size="5">
            <option value="">â€” All vendors â€”</option>
          </select>
          <div class="tiny">Hold <b>Ctrl/âŒ˜</b> to select multiple.</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="sessionSelect">Session (optional)</label>
          <select id="sessionSelect"><option value="">â€” All sessions â€”</option></select>
          <div class="tiny">Loaded from vendor report when you pick a vendor.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="tiny">Tip: select a single vendor to populate sessions.</div>
        </div>
      </div>
    </section>

    <!-- Report Options -->
    <section class="grid cols-3">
      <!-- Conference Report -->
      <section class="card" aria-labelledby="confrep">
        <h2 id="confrep" style="margin-top:0">Conference Report</h2>
        <div class="row">
          <div>
            <label>Format</label>
            <select id="formatConf">
              <option value="html">html</option>
              <option value="pdf">pdf</option>
              <option value="json">json</option>
              <option value="zip">zip</option>
            </select>
          </div>
          <div>
            <label>Template (optional)</label>
            <select id="templateConf">
              <option value="">(default)</option>
              <option value="executive">executive</option>
              <option value="detailed">detailed</option>
              <option value="summary">summary</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="inline" style="gap:8px; align-items:end">
            <div style="flex:1">
              <label for="includeAttachments">Include attachments in ZIP</label>
              <input id="includeAttachments" type="checkbox" />
            </div>
          </div>
          <div class="inline" style="gap:8px; align-items:end">
            <div style="flex:1">
              <label for="forceBgConf">Force background</label>
              <input id="forceBgConf" type="checkbox" />
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="btnbar">
          <button id="btnConfReport">Generate Conference Report</button>
        </div>
      </section>

      <!-- End of Day Report -->
      <section class="card" aria-labelledby="eodrep">
        <h2 id="eodrep" style="margin-top:0">End-of-Day Report</h2>
        <div class="row">
          <div>
            <label>Day</label>
            <input type="date" id="eodDate">
          </div>
          <div>
            <label>Format</label>
            <select id="eodFormat">
              <option value="html">html</option>
              <option value="pdf">pdf</option>
              <option value="json">json</option>
              <option value="zip">zip</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="inline" style="gap:8px; align-items:end">
            <div style="flex:1">
              <label for="forceBgEod">Force background</label>
              <input id="forceBgEod" type="checkbox" />
            </div>
          </div>
          <div></div>
        </div>
        <div class="tiny">Uses <span class="kbd">/api/reports/day/:conference_id/:date</span>.</div>
        <div class="divider"></div>
        <div class="btnbar">
          <button id="btnEodReport">Generate End-of-Day Report</button>
        </div>
      </section>

      <!-- Session / Vendor(s) -->
      <section class="card" aria-labelledby="svrep">
        <h2 id="svrep" style="margin-top:0">Session / Vendor(s)</h2>

        <div class="row">
          <div>
            <label>Session Report</label>
            <select id="sessionForReport"><option value="">â€” choose from Sessions dropdown above â€”</option></select>
          </div>
          <div>
            <label>Session Format</label>
            <select id="sessionFormat">
              <option value="json">json</option>
              <option value="pdf">pdf</option>
              <option value="html">html</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Vendor(s) Report</label>
            <div class="tiny">Select one or more vendors above â€” none = all vendors (JSON bundle).</div>
          </div>
          <div>
            <label>Vendor Format</label>
            <select id="vendorFormat">
              <option value="json">json (bundle if multiple)</option>
              <option value="pdf">pdf (per vendor)</option>
              <option value="html">html (per vendor)</option>
              <option value="zip">zip (per vendor)</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>
        <div class="btnbar">
          <button id="btnSessionReport" class="secondary">Generate Session Report</button>
          <button id="btnVendorsReport" class="secondary">Generate Vendor(s) Report</button>
        </div>
      </section>
    </section>

    <!-- Advanced Workflows -->
    <section class="card" aria-labelledby="adv" style="margin-top:14px">
      <h2 id="adv" style="margin-top:0">Advanced Workflows</h2>
      <div class="row">
        <div>
          <label>Regenerate last started report</label>
          <button id="btnRegenLast" disabled>Regenerate Last</button>
          <div class="tiny" id="lastStartUrl">Last: â€”</div>
        </div>
        <div>
          <label for="taskIdInput">Task ID</label>
          <input id="taskIdInput" placeholder="paste a task_id to check or download" />
          <div class="btnbar" style="margin-top:8px">
            <button id="btnCheckTask" class="secondary">Check Status</button>
            <button id="btnDownloadTask" class="secondary">Download by Task ID</button>
          </div>
        </div>
      </div>
      <div class="tiny">Tip: If status doesnâ€™t expose a direct download URL, re-call the original start URL with <span class="kbd">completed=true</span>.</div>
    </section>

    <!-- Bottom Output -->
    <footer id="outputBar">
      <aside class="card" aria-live="polite" id="logPanel">
        <h2 style="margin-top:0">Output</h2>
        <div id="log" class="tiny" style="white-space:pre-wrap;"></div>
        <div class="status" id="status"></div>
      </aside>
    </footer>
  </div>

  <span class="sr" aria-live="polite" id="live" style="position:absolute;left:-9999px"></span>

  <script>
  // Map requested format -> preferred Accept header
  function acceptFor(format){
    switch ((format||'').toLowerCase()){
      case 'html': return 'text/html';
      case 'pdf':  return 'application/pdf';
      case 'zip':  return 'application/zip';
      default:     return 'application/json';
    }
  }
  function extFrom(formatOrCt){
    const s = (formatOrCt||'').toLowerCase();
    if (s.includes('pdf') || s==='pdf')   return 'pdf';
    if (s.includes('html')|| s==='html')  return 'html';
    if (s.includes('zip') || s==='zip')   return 'zip';
    return 'json';
  }

  // UPDATED: runReportAndDownload â€” set Accepts correctly, keep poll flow
  async function runReportAndDownload({ startUrl, filenameBase, format='json' }){
    // Kick off with JSON-friendly Accept (202 body is JSON)
    let start;
    try {
      start = await apiFetchSmart(startUrl, { headers: { 'Accept':'application/json' } });
    } catch (e) {
      start = await apiFetchSmart(startUrl, { headers: { 'Accept':'application/json' } }, { tryQueryKeyFallback: true });
    }

    log('GET', maskKeyInUrl(start.url));

    if (start.status === 200) {
      // Could be JSON (direct) or rarely file
      return downloadFromResponse(start, filenameBase, format);
    }

    if (start.status === 202) {
      const body = await start.res.json();
      const taskId = body.task_id || body.id;
      const statusPath = body.check_status_url || body.status_url || `/reports/status/${taskId}`;
      log(`Task queued: ${taskId}. Polling statusâ€¦`);

      while (true) {
        await delay(3000);
        const status = await apiFetchSmart(statusPath, { headers:{ 'Accept':'application/json' } });
        const js = await status.res.json();
        log(`status=${js.status}`);
        if (js.status === 'completed') break;
        if (js.status === 'failed') throw new Error('Report generation failed.');
      }

      // Ask explicitly for the file we want
      const dlUrl = withParam(startUrl, 'completed', 'true');
      const dl = await apiFetchSmart(dlUrl, { headers:{ 'Accept': acceptFor(format) } });
      log('GET', maskKeyInUrl(dl.url));
      return downloadFromResponse(dl, filenameBase, format);
    }

    throw new Error(`Unexpected response: HTTP ${start.status}`);
  }

  // UPDATED: downloadFromResponse â€” follow download_url / s3_url if JSON
  async function downloadFromResponse(resp, base, format){
    const ct = resp.contentType || '';
    if (ct.includes('application/json')){
      const json = await resp.res.json();
      // If API gives us a direct URL, use it (preferred)
      const followUrl = json.download_url || json.result_url || json.url;
      if (followUrl){
        const f = await apiFetchSmart(followUrl, { headers:{ 'Accept': acceptFor(format) } }, { tryQueryKeyFallback:true });
        log('GET', maskKeyInUrl(f.url));
        const filename = pickFilename(f.dispo, json.filename || base, format, f.contentType);
        const blob = await f.res.blob();
        fileDownload(blob, ensureExt(filename, format, f.contentType));
        setStatus(`Report ready â†’ downloaded ${filename}.`,'ok');
        return;
      }

      // If only S3 is provided, fetch it directly
      if (json.s3_url){
        const s3 = await fetch(json.s3_url, { redirect:'follow' });
        if(!s3.ok) throw new Error(`S3 download failed: ${s3.status} ${s3.statusText}`);
        const s3Blob = await s3.blob();
        const fname = ensureExt(json.filename || `${base}`, format, s3.type || '');
        fileDownload(s3Blob, fname);
        setStatus(`Report ready â†’ downloaded ${fname}.`,'ok');
        return;
      }

      // Otherwise, save the JSON as a diagnostic file
      const fname = json.filename && extFrom(json.filename).includes('json')
        ? json.filename
        : `${base}.json`;
      const blob = new Blob([JSON.stringify(json,null,2)], {type:'application/json'});
      fileDownload(blob, fname);
      setStatus(`Report saved as JSON (no direct file URL present).`,'warn');
      return;
    }

    // Non-JSON: it's the actual file
    const filename = pickFilename(resp.dispo, base, format, ct);
    const blob = await resp.res.blob();
    fileDownload(blob, ensureExt(filename, format, ct));
    setStatus(`Report ready â†’ downloaded ${filename}.`,'ok');
  }

  function ensureExt(name, format, ct){
    const want = extFrom(format || ct);
    if (new RegExp(`\\.${want}$`, 'i').test(name)) return name;
    return `${name.replace(/\.(json|pdf|zip|html)$/i,'')}.${want}`;
  }
</script>

</body>
</html>
